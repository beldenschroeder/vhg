# Von Herff Gallery 

<a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a>

✨ **This workspace has been generated by [Nx, a Smart, fast and extensible build system.](https://nx.dev)** ✨

## Environment Configuration

The database used in this project uses Vercel's Postress database service. An example of how to set this up can be found at [How to Build a Fullstack App with Next.js, Prisma, and Vercel Postres](https://vercel.com/guides/nextjs-prisma-postgres#step-3-setup-prisma-and-create-the-database-schema). This appication hits an existing database endpoint on Vercel's database servers.

The command

```console
vercel env pull .env
```

sync's the project's _.env_ with the environment variables used on that Vercel project account.

The _schema.prisma_ file defines the schema to build the database. To do this, run

```console
pnpm exec prisma db push
```

To add data to the database tables created, you can do this via Prisma's Studio interface. Run the command

```console
pnpm exec prisma studio
```

In Prisma Studio, populate the tables with data.

If you ever need to update you Prisma schema (_schema.prisma_), you'll also need to ensure your Prisma Client (_libs/vhg/src/lib/prisma.tsx_) accounts for this change. To do that, run

```console
pnpm exec prisma generate
```

## Start the app

### Run the app on Vercel

This project is configured as a [Vercel project deployment](https://vercel.com/docs/getting-started-with-vercel/projects-deployments). Pushing changes up on any branch other than _master_ or _main_ will display a under the _Deployements_ section of Vercel's site as a _preview_ environment.

### Run app locally in development mode

To start the development server run `pnpm exec nx serve vhg`. Open your browser and navigate to http://localhost:3000/.

### Run app locally in a container in production mode

> NOTE: If you prefer to make updates to the app, you can give a new version tag to image by updating it in _/apps/vhg/project.json_, building the project again and run the Docker image again, as shown earlier.

#### Running with Docker Desktop

If you prefer to run Docker Desktop, be sure to install and run [Docker Desktop](https://www.docker.com/products/docker-desktop/).

After the Docker Desktop's Deamon is running, start the app in a Docker container locally in production mode, run

```console
pnpm i
pnpm exec prisma generate
pnpm exec nx container vhg
TODO: See if `-env-file` argument is even needed, as the env variables also defined in the Dockerfile. Or maybe it should be kept for different environment overrides.
docker run --env-file ./.env -p 3000:3000 -t beldenschroeder/vhg:1.0
```

Open your browser and navigate to http://localhost:3000/.

#### Running with Podman Desktop

If you prefer to run Podman Desktop, be sure to install and run [Podman Desktop](https://podman.io/).

After the Podman Desktop's Deamon is running, start the app in a Docker container locally in production mode, run

```console
pnpm i
pnpm exec prisma generate
pnpm exec nx container vhg
TODO: See if `--env-file` argument is even needed, as the env variables also defined in the Dockerfile. Or maybe it should be kept for different environment overrides.
podman run --env-file ./.env -p 3000:3000 -t beldenschroeder/vhg:1.0
```

Open your browser and navigate to http://localhost:3000/.

### Run app remotely in production with GitHub Actions

Before you can deploy the app using GitHub Actions, you'll need to build part of the AWS cloud infrastructure on which its hosted. The entire infrustructuion is segmented into three layers and each is built from its own repo.

The first two layers need to be built first. After this, you'll want to build and merge this _vhg_ project into the _main_ branch. Doing so will kick off a GitHub Action that publishes the app's container into [AWS ECR](https://aws.amazon.com/ecr/). Execute these builds from each repo in the fllowing order by following their README instructions:

#### 1. Base Infrastructure

Follow the deployment instructions in the [README.md](https://github.com/beldenschroeder/vhg-infra/blob/main/README.md) for the _vhg-infra_ repo.

#### 2. Platform Infrastructure

Follow the deployment instructions in the [README.md](https://github.com/beldenschroeder/vhg-infra-platform/blob/main/README.md) for the _vhg-infra-platform_ repo.

#### 3. App Container Deployment

##### 3.1 Build the App

At the root of this project directory, run

```console
pnpm i
pnpm exec prisma generate
pnpm exec nx build vhg
```

TODO: Update the _Dockerfile_ and _Dockerfile.prod_ files to have these files do the builds instead of having to build locally first. Make sure to also add _/dist/_ from the _.gitignore_ file as well.

##### 3.2 Deploy the App to Production

First check on the AWS account that will host this app if a container for the app already exists. You can determine this by going to the AWS Console and searching for "ECR". Make sure there isn't a container with the same tag as the one you're about to push up. If there is, simply remove it from the AWS Console.

After this check, temporarily remove the `postinstall` script from this project's root _package.json_ to prevent the _Dockerfile.prod_ from attempting to run it when this _package.json_file gets cloned into the container's environment and executed remotely. It's only meant to be run locally.

TODO: Remove the `postinstall` script later when replacing PostgreSQL with MongoDB.

Create a PR from your branch to the _main_ branch and merge it. This will kick off a GitHub Action to publish the app container to ECR.

#### 4. App Infrastructure

Follow the deployment instructions in the [README.md](https://github.com/beldenschroeder/vhg-infra-app/blob/main/README.md) for the _vhg-infra-app_ repo.

#### 5. Visit the Site

The app should now be hosted on http://vhgapp.beldenschroeder.me.
