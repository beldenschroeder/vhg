# Von Herff Gallery

<a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a>

✨ **This workspace has been generated by [Nx, a Smart, fast and extensible build system.](https://nx.dev)** ✨

## Start the app

### Run app locally in Development mode

To start the Development server run `pnpm exec nx serve vhg`. Open your browser and navigate to http://localhost:4200/.

### Run app locally in a Docker container in Production mode

To start the app in Docker container locally in Production mode, run

```console
pnpm exec nx container vhg
docker run -p 3000:3000 -t beldenschroeder/vhg:1.0
```

> NOTE: If you prefer to make updates to the app, you can give a new version tag to image by updating it in _/apps/vhg/project.json_, building the project again, and running to following imparitive command to update the image
>
> ```console
> kubectl set image deployment/vhg-deployment vhg=beldenschroeder/vhg:[tag]
> ```
>
> where _[tag]_ is the new tag name.

Open your browser and navigate to http://localhost:3000/.

### Run app locally using Kubernetes

After the Docker image is created, on the command line run

```console
kubectl apply -f k8s/
```

Install the Ingress-Nginx Controller by running

```console
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```

More about the installation of how to install using Helm can be found at the [Installation Guide](https://kubernetes.github.io/ingress-nginx/deploy/#quick-start).

Push the image to Docker Hub.

Open your browser and navigate to http://localhost:80/.

## Run app remotely using Kubernetes

After the Docker image is created and pushed to Docker Hub, build the AWS infrastructure.

Under _aws/vpc_, run

```
terraform init
terraform plan
terraform apply
```

Under _aws/eks_, run

```
terraform init
terraform plan
terraform apply
```

On the command line, update the Kubernetes config by running

```console
aws eks update-kubeconfig --name vhg-cluster --region us-east-1
```

Then, run

```console
kubectl apply -f k8s/
```

Install the Ingress-Nginx Controller by running

```console
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```

## Access the Kubernetes Dashboard

You can deploy the Von Herff Gallery to a Kubernetes cluster and manage cluster resources via the Kubernetes Dashboard. To do this, run the deploy command as explained in [Deploy and Access the Kubernetes Dashboard](https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/#deploying-the-dashboard-ui).

Then, run

```console
kubectl proxy
```

Then, visit the following URL in your browser to access your Dashboard

```console
http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
```

Obtain the token for this user by running the following in your terminal

```console
kubectl version
```

If your Kubernetes server version is v1.24 or higher you must run the following command

```console
kubectl -n kubernetes-dashboard create token admin-user
```

If your Kubernetes server version is older than v1.24 you must run the following command

```console
kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath="{.secrets[0].name}") -o go-template="{{.data.token | base64decode}}"
```

Copy the token from the above output and use it to log in at the dashboard.

After a successful login, you should now be redirected to the Kubernetes Dashboard.

The above steps can be found in the official documentation:
https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md

## Tear down the infrastructure

### Teardown from local setup

TODO: Fill in later. Similar to teardown for remote setup (see below).

### Teardown from remote setup

Uninstall the Ingress-Nginx Controller by running

```console
kubectl delete -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```

Delete all the K8s objects by going to _k8s/_ and running

```console
kubectl delete -f vhg-ingress-service.yaml
kubectl delete -f vhg-cluster-ip-service.yaml
kubectl delete -f vhg-deployment.yaml
```

Destroy all the EKS Terraform setup by going to _aws/eks_ and running

```console
terraform destroy
```

Destroy all the VPC Terraform setup by going to _aws/vpc_ and running

```console
terraform destroy
```

## TODO: Outdated. Remove later.
## Building the Infrastructure on AWS

With and AWS account set up, run the Terraform modules in _/terraform/_. Most of the files in her were inspired by [Create AWS EKS Fargate Using Terraform (EFS, HPA, Ingress, ALB, IRSA, Kubernetes, Helm, Tutorial)](https://antonputra.com/amazon/create-aws-eks-fargate-using-terraform/).

While just inside the _/terraform/_ directory, run

```console
terraform apply
```

Update the Kubernetes context by running

```console
aws eks update-kubeconfig --name vhg --region us-east-1
```

TODO: (Continue to add more documentation here.)

## Generate code

If you happen to use Nx plugins, you can leverage code generators that might come with it.

Run `nx list` to get a list of available plugins and whether they have generators. Then run `nx list <plugin-name>` to see what generators are available.

Learn more about [Nx generators on the docs](https://nx.dev/plugin-features/use-code-generators).

## Running tasks

To execute tasks with Nx use the following syntax:

```console
nx <target> <project> <...options>
```

You can also run multiple targets:

```console
nx run-many -t <target1> <target2>
```

..or add `-p` to filter specific projects

```console
nx run-many -t <target1> <target2> -p <proj1> <proj2>
```

Targets can be defined in the `package.json` or `projects.json`. Learn more [in the docs](https://nx.dev/core-features/run-tasks).

## Want better Editor Integration?

Have a look at the [Nx Console extensions](https://nx.dev/nx-console). It provides autocomplete support, a UI for exploring and running tasks & generators, and more! Available for VSCode, IntelliJ and comes with a LSP for Vim users.

## Ready to deploy?

Just run `nx build demoapp` to build the application. The build artifacts will be stored in the `dist/` directory, ready to be deployed.

## Set up CI!

Nx comes with local caching already built-in (check your `nx.json`). On CI you might want to go a step further.

- [Set up remote caching](https://nx.dev/core-features/share-your-cache)
- [Set up task distribution across multiple machines](https://nx.dev/core-features/distribute-task-execution)
- [Learn more how to setup CI](https://nx.dev/recipes/ci)

## Connect with us!

- [Join the community](https://nx.dev/community)
- [Subscribe to the Nx Youtube Channel](https://www.youtube.com/@nxdevtools)
- [Follow us on Twitter](https://twitter.com/nxdevtools)
